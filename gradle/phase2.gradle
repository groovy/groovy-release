import at.bxm.gradleplugins.svntools.api.SvnDepth
import at.bxm.gradleplugins.svntools.tasks.SvnAdd
import at.bxm.gradleplugins.svntools.tasks.SvnCheckout
import at.bxm.gradleplugins.svntools.tasks.SvnCommit
import at.bxm.gradleplugins.svntools.tasks.SvnDelete
import groovyx.net.http.RESTClient

import static groovyx.net.http.ContentType.JSON

buildscript {
    repositories {
        jcenter()
    }

    dependencies {
        classpath 'org.ajoberstar:grgit:1.7.0'
        classpath 'at.bxm.gradleplugins:gradle-svntools-plugin:2.1'
        classpath 'org.codehaus.groovy.modules.http-builder:http-builder:0.7.1'
        classpath 'org.hidetake:gradle-ssh-plugin:2.7.0'
    }
}

apply plugin: "at.bxm.svntools"
apply plugin: "org.hidetake.ssh"

svntools {
    username = apacheUser
    password = apachePassword
}

ssh.settings {
    dryRun = project.hasProperty('dryRun')
//    knownHosts = file(System.getProperty('user.home') + '/.ssh/known_hosts')
    knownHosts = allowAnyHosts
}

remotes {
    ciServer {
        host = 'ci.groovy-lang.org'
        user = findProperty('ciserver.user')
        password = findProperty('ciserver.password')
        //identity = file('id_rsa')
    }
}

task jiraCheckPhase2 {
    doLast {
        def jira = new groovyx.net.http.RESTClient('https://issues.apache.org/jira/rest/api/2/')
        def resp = jira.get(path: 'project/GROOVY/versions')
        assert resp.status == 200
        def versionFields = resp.data.find { it.name == relVersion }
        assert versionFields, "Version $relVersion not found in Jira!"
        assert versionFields.released, "Version $relVersion not yet released!"
        project.ext.versionId = versionFields.id
        project.ext.projectId = versionFields.projectId

        resp = jira.get(path: "version/$versionId/unresolvedIssueCount")
        assert resp.data
        if (resp.data.issuesUnresolvedCount) {
            logger.warn "Warning found $resp.data.issuesUnresolvedCount unresolved issues for version $relVersion"
        }
        resp = jira.get(path: "version/$versionId/relatedIssueCounts")
        assert resp.data
        project.ext.fixCount = resp.data.issuesFixedCount
    }
}

task promoteOnBintray {
    group = "Post-passed phase"
    description = "Releases the version on Bintray"
    dependsOn promoteOnBintray
}

task synchronizeWithMavenCentral {
    group = "Post-passed phase"
    description = "Releases the version on Bintray"
    dependsOn promoteOnBintray
}

task cleanSvnDistWorkspace(type: Delete) {
    dependsOn synchronizeWithMavenCentral
    project.ext.distWorkspaceRoot = "$project.buildDir/svn-dist-workspace-$branch"
    delete distWorkspaceRoot
}

task prepareSvnDistWorkspace(type: SvnCheckout, dependsOn: cleanSvnDistWorkspace) {
    svnUrl = "https://dist.apache.org/repos/dist/release/groovy"
    workspaceDir = distWorkspaceRoot
    rootProject.ext.distWorkspace = "$distWorkspaceRoot/$relVersion"
    depth = SvnDepth.FILES // slightly more efficient if we have two concurrent releases (e.g. 2.4.latest, 2.5.0)
}

task copyReleaseArtifacts(type: Copy, dependsOn: prepareSvnDistWorkspace) {
    description = "Copies all files from DEV to DIST"
    from(devWorkspace)
    into distWorkspace
}

task addSvnDistFiles(type: SvnAdd, dependsOn: copyReleaseArtifacts) {
    // TODO check whether this is needed since commit seems to do an add anyway?
    description = "Adds the changed files to dist svn"
    add distWorkspace
    recursive true
}

task deleteSvnDevFiles(type: SvnDelete, dependsOn: addSvnDistFiles) {
    description = "Deletes the changed files to svn"
    delete devWorkspace
}

task uploadToApacheDistServers {
    // svntools has no move so add and delete explicitly
    dependsOn deleteSvnDevFiles
    group = "Post-passed phase"
    description = "Moves the artifacts from the DEV subversion server to the DIST subversion server"
    doLast {
        // less declarative than ideal but we want deferred operation since
        // svn plugin assumes list of files to commit is known at config time
        def uploadBuild = project.tasks.create(name: "uploadBuild", type: GradleBuild)
        uploadBuild.startParameter.projectProperties = gradle.startParameter.projectProperties
        uploadBuild.tasks = ['uploadToApacheDistServersInternal']
        uploadBuild.execute()
    }
}

task uploadToApacheDistServersInternal(type: SvnCommit) {
    // TODO remove comments once testing is complete
    source << devWorkspace
    println distWorkspace
//    source << distWorkspace
    def tree = fileTree(distWorkspace).include('**/*')
    tree.visit {
        println "$distWorkspace/$it.path"
//        source << "$distWorkspace/$it.path"
    }
    commitMessage = "New version $branch $relVersion added"
}

task uploadDocumentationToGroovyWebsite {
    group = "Post-passed phase"
    description = "Uploads the documentation to the Groovy website server"
    dependsOn uploadToApacheDistServers
    ssh.run {
        session(remotes.ciServer) {
            execute 'uname -a'
            put from: "$stagingDir/target/distributions/apache-groovy-docs-${relVersion}.zip", into: '/var/www/docs/docs'
            execute "unzip -d /var/www/docs/docs/ /var/www/docs/docs/apache-groovy-docs-${relVersion}.zip"
            execute "chgrp -R teamcity /var/www/docs/docs/groovy-${relVersion}/"
            execute "rm /var/www/docs/docs/apache-groovy-docs-${relVersion}.zip"
        }
    }
}

task maybeUpdateDocumentationSymlink {
    group = "Post-passed phase"
    description = "Changes the symlink to the latest documentation if and only if it's a stable release"
    dependsOn uploadDocumentationToGroovyWebsite
    ssh.run {
        session(remotes.ciServer) {
            execute 'uname -a'
            execute "ln -s /var/www/docs/docs/latest groovy-$relVersion"
        }
    }
}

task publishToSDKman {
    group = "Post-passed phase"
    description = "Publishes the release on SDKman it and optionally makes it the default version"
    dependsOn maybeUpdateDocumentationSymlink
    doLast {
        def sdkman = new groovyx.net.http.RESTClient('https://vendors.sdkman.io/')
        sdkman.headers['consumer_key'] = consumerKey
        sdkman.headers['consumer_token'] = consumerToken
        def resp = jira.put(
                path: '/announce/struct',
                body: /{ "candidate": "groovy", "version": "$versionId", "hashtag" : "#groovylang" }/,
                requestContentType: JSON
        )
        assert resp.status == 200
        println resp.message
    }
}

task checkoutGroovyWebsite {
    group = "Post-passed phase"
    description = "Checks out the Groovy website repository"
    dependsOn publishToSDKman
}

task updateGroovySitemap {
    group = "Post-passed phase"
    description = "Updates sitemap.groovy to include the newly released version and commits the result"
    dependsOn checkoutGroovyWebsite
}

task pushGroovyWebsite {
    group = "Post-passed phase"
    description = "Pushes the Groovy website so that the new website is published"
    dependsOn updateGroovySitemap
}

task waitForWebsitePublication {
    group = "Post-passed phase"
    description = "Polls the Groovy website to check if it is released"
    // check if http://groovy-lang.org/changelogs/changelog-2.4.7.html is created
    dependsOn pushGroovyWebsite
}

task proposeAnnouncementEmail {
    group = "Post-passed phase"
    description = "Generates an [ANN] thread to be tweaked and sent to the dev@, user@ and announce@ mailing lists"
    dependsOn waitForWebsitePublication
    doLast {
        println """"
Below is a template email to tweak and send to the dev@, user@ and announce@ mailing lists as an [ANNOUNCE] thread.

---------------- >8 -----------------

Dear community,

We are pleased to announce version $versionId of Apache Groovy.
Apache Groovy is a multi-facet programming language for the JVM.
Further details can be found at the http://groovy.apache.org website.

This release is a maintenance release of the 2.4.x branch, but contains critical fixes, in particular a fix
for a 0-day vulnerability. Details can be found on http://groovy-lang.org/security.html

It is strongly encouraged that all users upgrade to this version.

This release includes $fixCount bug fixes/improvements as outlined in the changelog:
https://issues.apache.org/jira/secure/ReleaseNote.jspa?projectId=$projectId&version=$versionId

Sources can be downloaded from: http://www.groovy-lang.org/download.html
Convenience binaries, SDK and documentation can be found at: http://www.groovy-lang.org/download.html

We would like to thank all people who contributed to this release.

We welcome your help and feedback. For more information on how to
report problems, and to get involved, visit the project website at
https://groovy.apache.org/

Best regards,
"""
    }
}

task announceReleaseOnSDKman {
    group = "Post-passed phase"
    description = "Announces the release on SDKman"
    dependsOn proposeAnnouncementEmail
}


